<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Super Mario Math Adventure - A fun way to practice multiplication">
    <title>Super Mario Math Adventure</title>
    <style>
        /* Base styles */
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            min-height: 100vh;
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Improved accessibility and focus states */
        input:focus {
            outline: 2px solid #4B0082;
            box-shadow: 0 0 3px rgba(75, 0, 130, 0.5);
        }

        button:focus {
            outline: 2px solid #4B0082;
            box-shadow: 0 0 3px rgba(75, 0, 130, 0.5);
        }

        /* Rest of your existing styles... */
        /* [Previous styles remain the same] */
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <header>
            <h1 class="title">Super Mario Math Adventure</h1>
            <button onclick="toggleSound()" aria-label="Toggle sound" class="sound-toggle">
                <span id="soundIcon">ðŸ”Š</span>
            </button>
        </header>

        <!-- Rest of your HTML structure... -->
        <!-- [Previous HTML remains the same] -->
    </div>

    <script>
        // Constants
        const GAME_CONFIG = {
            GRID_SIZE: 12,
            INITIAL_TIME: 300,
            COIN_SOUND_URL: 'https://themushroomkingdom.net/sounds/wav/smb/smb_coin.wav'
        };

        // State management
        const gameState = {
            timeLeft: GAME_CONFIG.INITIAL_TIME,
            correctAnswers: {},
            userAnswers: {},
            coins: 0,
            isMuted: false,
            timerInterval: null,
            coinSound: new Audio(GAME_CONFIG.COIN_SOUND_URL)
        };

        // Improved error handling for audio
        gameState.coinSound.addEventListener('error', (e) => {
            console.error('Error loading coin sound:', e);
            // Fallback to silent operation if sound fails to load
            gameState.isMuted = true;
        });

        // Input validation
        function validateInput(value, row, col) {
            const numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 0 || numValue > row * col) {
                return false;
            }
            return true;
        }

        // Enhanced handleInput function
        function handleInput(event) {
            const input = event.target;
            const row = parseInt(input.dataset.row);
            const col = parseInt(input.dataset.col);
            const value = input.value.trim();

            if (value === '') {
                delete gameState.userAnswers[`${row}-${col}`];
                return;
            }

            if (!validateInput(value, row, col)) {
                input.value = '';
                return;
            }

            const numValue = parseInt(value);
            gameState.userAnswers[`${row}-${col}`] = numValue;

            if (numValue === gameState.correctAnswers[`${row}-${col}`]) {
                if (!gameState.isMuted) {
                    playSuccessSound();
                }
                addCoinToChest();
                highlightCorrectAnswer(input);
            }
        }

        // Improved sound handling
        function playSuccessSound() {
            try {
                gameState.coinSound.currentTime = 0;
                gameState.coinSound.play().catch(e => {
                    console.error('Error playing sound:', e);
                    gameState.isMuted = true;
                });
            } catch (e) {
                console.error('Error with audio playback:', e);
                gameState.isMuted = true;
            }
        }

        // More robust timer management
        function startTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }

            gameState.timerInterval = setInterval(() => {
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timerInterval);
                    endGame();
                    return;
                }

                gameState.timeLeft--;
                updateTimerDisplay();
            }, 1000);
        }

        // Game initialization with error handling
        function initializeGame() {
            try {
                createGrid();
                loadSavedState();
                startTimer();
                updateShopItems();
            } catch (e) {
                console.error('Error initializing game:', e);
                alert('There was an error starting the game. Please refresh the page.');
            }
        }

        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeGame);

        // [Rest of your JavaScript code remains the same but with similar improvements]
    </script>
</body>
</html>
